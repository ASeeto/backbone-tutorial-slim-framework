<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Mock Shopping Cart</title>
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
</head>
<body>

<div class="container">
<h1>Product Listings</h1>
<hr />
<div class="page"></div>
</div>

<script src="js/jquery.min.js" type="text/javascript"></script>
<script src="js/underscore-min.js" type="text/javascript"></script>
<script src="js/backbone-min.js"></script>

<script type="text/template" id="item-list-template">
    <a href="#/new" class="btn btn-primary">New</a>
    <hr />
    <table class="table striped">
        <thead>
            <tr>
                <th>ID</th><th>Name</th><th>Price</th><th></th>
            </tr>
        </thead>
        <tbody>
        <% _.each(items, function(item) { %>
            <tr>
                <td><%= htmlEncode(item.get('id')) %></td>
                <td><%= htmlEncode(item.get('name')) %></td>
                <td><%= htmlEncode(item.get('price')) %></td>
                <td><a class="btn" href="#/edit/<%= item.id %>">Edit</a></td>
            </tr>
        <% }); %>
        </tbody>
    </table>
</script>

<script type="text/template" id="edit-item-template">
    <form class="edit-item-form">
        <legend><%= item ? 'Edit' : 'New' %> Item</legend>
            <label>Name</label>
            <input name="name" type="text" value="<%= item ? item.get('name') : '' %>">
            <label>Price</label>
            <input name="price" type="text" value="<%= item ? item.get('price') : '' %>">
            <hr />
            <button type="submit" class="btn"><%= item ? 'Update' : 'Create' %></button>
            <% if(item) { %>
            <input type="hidden" name="id" value="<%= item.id %>" />
            <button data-item-id="<%= item.id %>" class="btn btn-danger delete">Delete</button>
        <% }; %>
    </form>
</script>

<script>
    function htmlEncode(value){
      return $('<div/>').text(value).html();
    }
    $.fn.serializeObject = function() {
        var o = {};
        var a = this.serializeArray();
        $.each(a, function() {
            if (o[this.name] !== undefined) {
                if (!o[this.name].push) {
                    o[this.name] = [o[this.name]];
                }
                o[this.name].push(this.value || '');
            } else {
                o[this.name] = this.value || '';
            }
        });
        return o;
    }

    var Item = Backbone.Model.extend({
        urlRoot: '/api/index.php/api/item',
        parse: function(data){
            if(null != data){
                return data[0];
            }
        }
    });

    var Items = Backbone.Collection.extend({
        url: '/api/index.php/api/item'
    });

    // View for Item List
    var ItemListView = Backbone.View.extend({
        el: '.page',
        render: function () {
            var that = this;
            var items = new Items();
            items.fetch({
                success: function (items) {
                    var template = _.template($('#item-list-template').html(), {items: items.models});
                    that.$el.html(template);
                },
                error: function (){
                    that.$el.html( ' Error when fetching collection. ');
                }
            })
        }
    });

    // Initialize a new Item List View to be rendered
    var itemListView = new ItemListView();

    // View for Edit List
    var EditItemView = Backbone.View.extend({
        el: '.page',
            events: {
                'submit .edit-item-form': 'saveItem',
                'click .delete': 'deleteItem'
        },
        saveItem: function (ev) {
            var itemDetails = $(ev.currentTarget).serializeObject();
            var item = new Item();
            item.save(itemDetails, {
                success: function (item) {
                    router.navigate('', {trigger:true});
                }
            });
            return false;
        },
        deleteItem: function (ev) {
            this.item.destroy({
                success: function () {
                    router.navigate('', {trigger:true});
                }
            })
        },
        render: function (options) {
            var that = this;
            if(options.id) {
                that.item = new Item({id: options.id});
                that.item.fetch({
                    success: function (item) {
                        var template = _.template($('#edit-item-template').html(), {item: item});
                        that.$el.html(template);
                    }
                })
            } else {
                var template = _.template($('#edit-item-template').html(), {item: null});
                that.$el.html(template);
            }
        }
    });

    // Initialize a new Edit List View to be rendered
    var editItemView = new EditItemView();

    // Routes!!!
    var Router = Backbone.Router.extend({
        routes: {
          "": "home", 
          "edit/:id": "edit",
          "new": "edit"
        }
    });

    // Initialize a new Router
    var router = new Router;

    // listening for home event 
    router.on('route:home', function() {
        // render item list
        itemListView.render();
    })
    // listening for edit event 
    router.on('route:edit', function(id) {
        editItemView.render({id: id})
    })

    Backbone.history.start();
</script>

</body>
</html>